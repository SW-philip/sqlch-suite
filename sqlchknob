#!/bin/bash
set -euo pipefail

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/sqlch"
STATION_FILE="$CONFIG_DIR/stations"

mkdir -p "$CONFIG_DIR"
touch "$STATION_FILE"

choose_play() {
  if [ ! -s "$STATION_FILE" ]; then
    gum style --foreground 212 "No stations saved yet."
    sleep 2
    return
  fi

  station=$(awk -F= '{print $1}' "$STATION_FILE" | gum choose --header="ğŸ§ Choose a station to play")
  if [ -n "$station" ]; then
    sqlchctl play "$station"
  fi
}

search_and_add() {
  query=$(gum input --placeholder "Search genre/tag (e.g. jazz, chill, metal)")
  if [ -z "$query" ]; then return; fi

  results=$(curl -fsSL "https://de1.api.radio-browser.info/json/stations/bytag/$query" | jq -r '.[] | "\(.name)=\(.url)"' | gum choose --no-limit --header="ğŸ¯ Pick a station to add")
  [ -z "$results" ] && return

  echo "$results" >>"$STATION_FILE"
  gum style --foreground 42 "âœ… Added: $(echo "$results" | cut -d= -f1)"
  sleep 1
}

delete_station() {
  if [ ! -s "$STATION_FILE" ]; then
    gum style --foreground 212 "âš  No stations to delete."
    sleep 2
    return
  fi

  station=$(awk -F= '{print $1}' "$STATION_FILE" | gum choose --header="âŒ Pick a station to delete")
  if [ -n "$station" ]; then
    grep -v "^$station=" "$STATION_FILE" >"$STATION_FILE.tmp" && mv "$STATION_FILE.tmp" "$STATION_FILE"
    gum style --foreground 160 "ğŸ—‘ Deleted: $station"
    sleep 1
  fi
}

edit_station() {
  if [ ! -s "$STATION_FILE" ]; then
    gum style --foreground 212 "No stations saved yet."
    sleep 2
    return
  fi

  # Let user pick station to edit
  original=$(awk -F= '{print $1}' "$STATION_FILE" | gum choose --header="âœï¸ Choose a station to edit")
  [ -z "$original" ] && return

  # Get full line
  full_line=$(grep "^$original=" "$STATION_FILE")
  name=$(echo "$full_line" | cut -d= -f1)
  url=$(echo "$full_line" | cut -d= -f2)

  # Prompt edits
  new_name=$(gum input --placeholder "Station name" --value "$name")
  new_url=$(gum input --placeholder "Stream URL" --value "$url")

  # Replace line
  sed -i "/^$name=/d" "$STATION_FILE"
  echo "$new_name=$new_url" >>"$STATION_FILE"

  gum style --foreground 42 "âœ… Updated: $new_name"
  sleep 1
}

main_menu() {
  while true; do
    choice=$(gum choose --header "ğŸ› sqlchKNOB Control Panel" "â–¶ Play a station" "ğŸ” Search & Add Station" "âŒ Delete Station" "âœï¸ Edit Station" "ğŸšª Exit")

    case "$choice" in
    "â–¶ Play a station") choose_play ;;
    "ğŸ” Search & Add Station") search_and_add ;;
    "âŒ Delete Station") delete_station ;;
    "âœï¸ Edit Station") edit_station ;;
    "ğŸšª Exit") break ;;
    esac
  done
}

main_menu
